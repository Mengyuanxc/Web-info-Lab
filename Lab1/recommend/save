import random
import torch
from sklearn.model_selection import train_test_split
from torch import nn
from torch.utils.data import Dataset, DataLoader
import pandas as pd

class Data(Dataset):
    def __init__(self, data, embedding_table):
        self.data = data
        self.embedding_table = embedding_table

    def __getitem__(self, idx):
        row = self.data.iloc[idx]
        user = row[0]
        item = row[1]
        rating = row['Rate'].astype('float32')
        embedding = self.embedding_table[idx]        #为1代表已遮盖，为0代表未遮盖
        return user, item, rating, embedding

#电影的dataset和dataloader
Movie_dir = "./data/movie_score.csv"
Movie_data = pd.read_csv(Movie_dir)
Movie_train_data, Movie_test_data = train_test_split(Movie_data, test_size=0.5, random_state=10)

Movie_train_embedding = [0]     #1和0相等的随机数组，模拟遮盖一半数据
for i in range(0,len(Movie_train_data)-1):
    Movie_train_embedding.append(1-Movie_train_embedding[i])
random.shuffle(Movie_train_embedding)
Movie_train_dataset = Data(Movie_train_data, Movie_train_embedding)

Movie_test_embedding = [0]     #1和0相等的随机数组，模拟遮盖一半数据
for i in range(0,len(Movie_test_data)-1):
    Movie_test_embedding.append(1-Movie_test_embedding[i])
random.shuffle(Movie_test_embedding)
Movie_test_dataset = Data(Movie_test_data, Movie_test_embedding)

#返回顺序：User_ID, Movie_ID, Rating, Embedding
Movie_train_dataloader = DataLoader(Movie_train_dataset, batch_size=4096, shuffle=True, drop_last = True)
Movie_test_dataloader = DataLoader(Movie_test_dataset, batch_size=4096, shuffle=False, drop_last = True)



Book_dir = "./data/book_score.csv"
Book_data = pd.read_csv(Book_dir)
Book_train_data, Book_test_data = train_test_split(Book_data, test_size=0.5, random_state=10)

Book_train_embedding = [0]     #1和0相等的随机数组，模拟遮盖一半数据
for i in range(0,len(Book_train_data)-1):
    Book_train_embedding.append(1-Book_train_embedding[i])
random.shuffle(Book_train_embedding)
Book_train_dataset = Data(Book_train_data, Book_train_embedding)

Book_test_embedding = [0]     #1和0相等的随机数组，模拟遮盖一半数据
for i in range(0,len(Book_test_data)-1):
    Book_test_embedding.append(1-Book_test_embedding[i])
random.shuffle(Book_test_embedding)
Book_test_dataset = Data(Book_test_data, Book_test_embedding)

#返回顺序：User_ID, Book_ID, Rating, Embedding
Book_train_dataloader = DataLoader(Book_train_dataset, batch_size=4096, shuffle=True, drop_last = True)
Book_test_dataloader = DataLoader(Book_test_dataset, batch_size=4096, shuffle=False, drop_last = True)

